# Ротация RADIUS_SECRET (процедура)

Цель: безопасно менять `RADIUS_SECRET` без простоя AnyConnect/ASA/FTD.

## Периодичность
- Рекомендуемо: каждые 180 дней (см. `docs/secrets-policy.md`).
- Внепланово: при компрометации или утечке.

## Подготовка
1) Согласовать окно ротации с сетевой командой.
2) Сгенерировать новый `RADIUS_SECRET` и сохранить в секрет‑хранилище.
3) Подготовить план отката (старый секрет).

## Процедура (без простоя)
Поддерживается, если ASA/FTD и RADIUS допускают параллельные ключи.

1) Добавить **новый** `RADIUS_SECRET` в секрет‑хранилище.
2) Обновить секреты в кластере (ExternalSecret/Secret).
3) Обновить RADIUS‑подписчики:
   - сначала добавить новый ключ на ASA/FTD,
   - затем оставить оба ключа на время перехода.
4) Убедиться, что логины проходят с новым ключом:
   - `radius_requests_total{result="accept"}` стабильно растет,
   - нет всплеска `reject`.
5) Удалить старый ключ на ASA/FTD.
6) Удалить старый ключ из секрет‑хранилища.

## Процедура (с коротким окном)
Если ASA/FTD не поддерживает параллельные ключи:
1) Обновить секрет в кластере.
2) Быстро обновить ключ на ASA/FTD.
3) Проверить `/healthz` и `radius_requests_total`.

## Проверка после ротации
- Авторизация AnyConnect проходит.
- `radius_requests_total{result="reject|timeout"}` не выросла.
- Логи RADIUS без ошибок "invalid secret".

## Откат
1) Вернуть старый ключ на ASA/FTD.
2) Вернуть старый секрет в кластере.
3) Зафиксировать причину и повторить позже.
