# Тест восстановления RADIUS/VPN после сбоя

Цель: проверить устойчивость 2FA для AnyConnect/ASA/FTD и
восстановление RADIUS после типовых инцидентов.

## Предусловия
- Развернуты API и RADIUS в Kubernetes.
- Настроен доступ ASA/FTD к RADIUS (UDP/1812).
- Доступны `/healthz` и `/metrics`.

## Сценарии

### 1) Сбой RADIUS‑пода
1) Удалить один pod RADIUS.
2) Убедиться, что сервис продолжает отвечать через другие pod.
3) Проверить рост `radius_requests_total` на всех pod.

Ожидаемо: кратковременный рост timeouts, затем восстановление.

### 2) Сбой API‑пода
1) Удалить один pod API.
2) Проверить, что `/healthz` доступен и RADIUS отвечает.
3) Проверить авторизацию/2FA пользователя.

Ожидаемо: без ошибок при наличии нескольких pod API.

### 3) Потеря Redis
1) Остановить Redis (или ограничить доступ).
2) Выполнить попытку логина.
3) Проверить `redis_ping_total{result="error"}`.

Ожидаемо: деградация ограничителей/сессий, фиксация ошибок.

### 4) Потеря PostgreSQL
1) Остановить PostgreSQL (или ограничить доступ).
2) Проверить `/healthz` и метрики `db_ping_total`.
3) Восстановить БД и повторить логин.

Ожидаемо: `healthz` показывает деградацию, после восстановления — OK.

### 5) Недоступность внешнего провайдера
1) Имитировать ошибку провайдера (SMS/Push/Call).
2) Проверить срабатывание retry/CB.

Ожидаемо: рост `provider_*` ошибок, отсутствие зависания.

## Критерии успешности
- RADIUS восстанавливает работоспособность после сбоя pod.
- ASA/FTD возвращается к `accept` без ручных вмешательств.
- `radius_requests_total{result="timeout|error"}` не остается повышенным.
- `healthz` снова показывает `ok` по Redis/БД после восстановления.

## Фиксация результатов
- Дата, длительность, RTO.
- Что сломалось и что потребовало ручного вмешательства.
- Рекомендации и корректировки таймаутов/ретраев.
