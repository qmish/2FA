# План восстановления (DR)

## Цели
- Быстрое восстановление доступности API и RADIUS.
- Минимизация потери данных (PostgreSQL, Redis).
- Воспроизводимость процедуры на стенде.

## Предпосылки
- Регулярные бэкапы PostgreSQL (`pg_dump`) сохранены и проверены.
- Доступ к секретам (JWT/RADIUS/FCM и др.) обеспечен вне репозитория.
- Известен актуальный образ/тег релиза.
- Инфраструктура K8s и доступ к namespace доступны.

## RTO/RPO (рекомендации)
- RTO: до 30–60 минут.
- RPO: зависит от расписания бэкапов (например, 24 часа).

## Процедура восстановления
1. **Остановить доступ** (по необходимости):
   - Временно ограничить ingress или масштабировать API в 0.
2. **Восстановить PostgreSQL**:
   - Поднять чистый экземпляр PostgreSQL или кластер оператора.
   - Восстановить дамп:
     ```bash
     psql "$DB_URL" < backup-YYYY-MM-DD-HHMMSS.sql
     ```
3. **Применить миграции**:
   ```bash
   go run ./cmd/migrate
   ```
4. **Восстановить конфигурацию и секреты**:
   - Убедиться, что секреты корректны и не `CHANGE_ME`.
5. **Восстановить API и RADIUS**:
   - Применить манифесты или выполнить `helm upgrade --install`.
6. **Проверка работоспособности**:
   - `GET /healthz`, `GET /metrics`.
   - Проверка авторизации и 2FA.
7. **Возврат доступа**:
   - Включить ingress/масштабировать API до нормальных значений.

## Тест восстановления
- Раз в квартал проводить тест восстановления на стенде.
- Зафиксировать время RTO и итоговый статус.

## Примечания
- Redis можно восстановить из снапшотов, если включены AOF/RDB.
- Для HA Postgres используйте операторы (пример: `docs/k8s/postgres-cnpg.yaml`).
